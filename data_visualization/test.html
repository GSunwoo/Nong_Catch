<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë†ì‚°ë¬¼ ê°€ê²©-ìƒì‚°ëŸ‰ ì‹œê°í™”</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .file-upload {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .file-input {
            margin: 10px;
            padding: 10px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            display: inline-block;
        }

        .file-input input[type="file"] {
            padding: 10px;
            border: none;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .year-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .year-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .year-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .year-btn:active {
            transform: translateY(0);
        }

        .year-display {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            min-width: 100px;
            text-align: center;
            padding: 10px 20px;
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .crop-selector {
            margin-left: 30px;
        }

        .crop-selector select {
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 25px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
        }

        .crop-selector select:focus {
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-wrapper {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .chart-wrapper:hover {
            transform: translateY(-5px);
        }

        .chart-title {
            text-align: center;
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .correlation-chart {
            grid-column: 1 / -1;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                gap: 15px;
            }

            .crop-selector {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ğŸŒ¾ ë†ì‚°ë¬¼ ê°€ê²©-ìƒì‚°ëŸ‰ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
        </div>

        <div class="file-upload">
            <h3>CSV íŒŒì¼ ì—…ë¡œë“œ</h3>
            <div class="file-input">
                <label>ì–‘íŒŒ: <input type="file" id="onionFile" accept=".csv"></label>
            </div>
            <div class="file-input">
                <label>ë”¸ê¸°: <input type="file" id="strawberryFile" accept=".csv"></label>
            </div>
            <div class="file-input">
                <label>ë§ˆëŠ˜: <input type="file" id="garlicFile" accept=".csv"></label>
            </div>
            <div class="file-input">
                <label>ë³µìˆ­ì•„: <input type="file" id="peachFile" accept=".csv"></label>
            </div>
            <div id="loadingStatus" class="loading" style="display: none;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
        </div>

        <div class="controls">
            <div class="year-control">
                <button class="year-btn" id="prevYear">â—€ ì´ì „</button>
                <div class="year-display" id="yearDisplay">2023</div>
                <button class="year-btn" id="nextYear">ë‹¤ìŒ â–¶</button>
            </div>

            <div class="crop-selector">
                <select id="cropSelect">
                    <option value="ì–‘íŒŒ">ğŸ§… ì–‘íŒŒ</option>
                    <option value="ë”¸ê¸°">ğŸ“ ë”¸ê¸°</option>
                    <option value="ë§ˆëŠ˜">ğŸ§„ ë§ˆëŠ˜</option>
                    <option value="ë³µìˆ­ì•„">ğŸ‘ ë³µìˆ­ì•„</option>
                </select>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-wrapper">
                <div class="chart-title">ì›”ë³„ ê°€ê²© ë³€í™”</div>
                <canvas id="priceChart"></canvas>
            </div>

            <div class="chart-wrapper">
                <div class="chart-title">ì›”ë³„ ìƒì‚°ëŸ‰ ë³€í™”</div>
                <canvas id="productionChart"></canvas>
            </div>
        </div>

        <div class="correlation-chart">
            <div class="chart-title">ê°€ê²© vs ìƒì‚°ëŸ‰ ìƒê´€ê´€ê³„</div>
            <canvas id="correlationChart"></canvas>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="avgPrice">-</div>
                <div class="stat-label">í‰ê·  ê°€ê²© (ì›/kg)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgProduction">-</div>
                <div class="stat-label">í‰ê·  ìƒì‚°ëŸ‰ (í†¤)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="correlation">-</div>
                <div class="stat-label">ê°€ê²©-ìƒì‚°ëŸ‰ ìƒê´€ê³„ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="peakMonth">-</div>
                <div class="stat-label">ìµœê³ ê°€ ì›”</div>
            </div>
        </div>
    </div>

    <script>
        // ì‹¤ì œ ë°ì´í„°ë¥¼ ì €ì¥í•  ê°ì²´
        let cropData = {};
        let currentYear = 2023;
        let currentCrop = 'ì–‘íŒŒ';
        let availableYears = [];

        const months = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];

        // ì°¨íŠ¸ ê°ì²´ë“¤
        let priceChart, productionChart, correlationChart;

        // CSV íŒŒì¼ ë§¤í•‘
        const fileMapping = {
            'ì–‘íŒŒ': 'onionFile',
            'ë”¸ê¸°': 'strawberryFile',
            'ë§ˆëŠ˜': 'garlicFile',
            'ë³µìˆ­ì•„': 'peachFile'
        };

        // CSV íŒŒì¼ ì½ê¸° í•¨ìˆ˜
        const loadCSVFile = (file, cropName) => {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    encoding: 'UTF-8',
                    complete: function(results) {
                        console.log(`${cropName} ë°ì´í„° ë¡œë“œ ì™„ë£Œ:`, results.data.length, 'í–‰');
                        resolve({ cropName, data: results.data });
                    },
                    error: function(error) {
                        console.error(`${cropName} íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:`, error);
                        reject(error);
                    }
                });
            });
        };

        // ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜
        const processData = (rawData) => {
            const processed = {};

            rawData.forEach(({ cropName, data }) => {
                processed[cropName] = {};

                data.forEach(row => {
                    // ë‚ ì§œ íŒŒì‹± (ì—¬ëŸ¬ í˜•ì‹ ì§€ì›)
                    let date;
                    if (row['ë‚ ì§œ']) {
                        date = new Date(row['ë‚ ì§œ']);
                    } else if (row['date']) {
                        date = new Date(row['date']);
                    } else {
                        return; // ë‚ ì§œê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
                    }

                    if (isNaN(date.getTime())) return; // ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ ìŠ¤í‚µ

                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;

                    // ê°€ê²©ê³¼ ìƒì‚°ëŸ‰ ë°ì´í„° ì¶”ì¶œ
                    const price = parseFloat(row['ê°€ê²©'] || row['price'] || 0);
                    const production = parseFloat(row['ìƒì‚°ëŸ‰'] || row['production'] || 0);

                    if (!processed[cropName][year]) {
                        processed[cropName][year] = {
                            prices: new Array(12).fill(0),
                            production: new Array(12).fill(0),
                            counts: new Array(12).fill(0)
                        };
                    }

                    // ì›”ë³„ ë°ì´í„° ëˆ„ì  (í‰ê·  ê³„ì‚°ì„ ìœ„í•´)
                    processed[cropName][year].prices[month - 1] += price;
                    processed[cropName][year].production[month - 1] += production;
                    processed[cropName][year].counts[month - 1]++;
                });

                // í‰ê·  ê³„ì‚°
                Object.keys(processed[cropName]).forEach(year => {
                    const yearData = processed[cropName][year];
                    for (let i = 0; i < 12; i++) {
                        if (yearData.counts[i] > 0) {
                            yearData.prices[i] /= yearData.counts[i];
                            yearData.production[i] /= yearData.counts[i];
                        }
                    }
                    delete yearData.counts; // ë” ì´ìƒ í•„ìš”ì—†ìŒ
                });
            });

            return processed;
        };

        // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const setupFileUploaders = () => {
            Object.entries(fileMapping).forEach(([cropName, fileInputId]) => {
                document.getElementById(fileInputId).addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            document.getElementById('loadingStatus').style.display = 'block';
                            const result = await loadCSVFile(file, cropName);

                            // ê°œë³„ ì‘ë¬¼ ë°ì´í„° ì²˜ë¦¬
                            const processedData = processData([result]);

                            // ê¸°ì¡´ ë°ì´í„°ì— ë³‘í•©
                            cropData = { ...cropData, ...processedData };

                            // ì‚¬ìš© ê°€ëŠ¥í•œ ì—°ë„ ì—…ë°ì´íŠ¸
                            updateAvailableYears();

                            // ì²« ë²ˆì§¸ ë°ì´í„° ë¡œë“œì‹œ ì°¨íŠ¸ ì´ˆê¸°í™”
                            if (Object.keys(cropData).length === 1) {
                                initCharts();
                            }

                            // í˜„ì¬ ì‘ë¬¼ì´ ë¡œë“œëœ ê²½ìš° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                            if (cropName === currentCrop) {
                                updateCharts();
                            }

                            console.log(`${cropName} ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ`);

                        } catch (error) {
                            console.error(`${cropName} íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:`, error);
                            alert(`${cropName} íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
                        } finally {
                            document.getElementById('loadingStatus').style.display = 'none';
                        }
                    }
                });
            });
        };

        // ì‚¬ìš© ê°€ëŠ¥í•œ ì—°ë„ ì—…ë°ì´íŠ¸
        const updateAvailableYears = () => {
            const years = new Set();
            Object.values(cropData).forEach(crop => {
                Object.keys(crop).forEach(year => years.add(parseInt(year)));
            });
            availableYears = Array.from(years).sort();

            if (availableYears.length > 0) {
                currentYear = Math.max(...availableYears);
                document.getElementById('yearDisplay').textContent = currentYear;
            }
        };

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        const initCharts = () => {
            // ê°€ê²© ì°¨íŠ¸
            const priceCtx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'ê°€ê²© (ì›/kg)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });

            // ìƒì‚°ëŸ‰ ì°¨íŠ¸
            const productionCtx = document.getElementById('productionChart').getContext('2d');
            productionChart = new Chart(productionCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'ìƒì‚°ëŸ‰ (í†¤)',
                        data: [],
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderColor: '#764ba2',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });

            // ìƒê´€ê´€ê³„ ì°¨íŠ¸
            const correlationCtx = document.getElementById('correlationChart').getContext('2d');
            correlationChart = new Chart(correlationCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'ê°€ê²© vs ìƒì‚°ëŸ‰',
                        data: [],
                        backgroundColor: 'rgba(240, 147, 251, 0.8)',
                        borderColor: '#f093fb',
                        borderWidth: 2,
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'ìƒì‚°ëŸ‰ (í†¤)'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ê°€ê²© (ì›/kg)'
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
        };

        // ë°ì´í„° ì—…ë°ì´íŠ¸
        const updateCharts = () => {
            if (!cropData[currentCrop] || !cropData[currentCrop][currentYear]) {
                console.log('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤:', currentCrop, currentYear);
                return;
            }

            const data = cropData[currentCrop][currentYear];

            // ê°€ê²© ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            priceChart.data.datasets[0].data = data.prices;
            priceChart.update('active');

            // ìƒì‚°ëŸ‰ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            productionChart.data.datasets[0].data = data.production;
            productionChart.update('active');

            // ìƒê´€ê´€ê³„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            const correlationData = data.prices.map((price, index) => ({
                x: data.production[index],
                y: price
            })).filter(point => point.x > 0 && point.y > 0); // 0ê°’ ì œì™¸

            correlationChart.data.datasets[0].data = correlationData;
            correlationChart.update('active');

            // í†µê³„ ì—…ë°ì´íŠ¸
            updateStats(data);
        };

        // í†µê³„ ì—…ë°ì´íŠ¸
        const updateStats = (data) => {
            const validPrices = data.prices.filter(p => p > 0);
            const validProduction = data.production.filter(p => p > 0);

            if (validPrices.length === 0 || validProduction.length === 0) {
                document.getElementById('avgPrice').textContent = '-';
                document.getElementById('avgProduction').textContent = '-';
                document.getElementById('correlation').textContent = '-';
                document.getElementById('peakMonth').textContent = '-';
                return;
            }

            const avgPrice = (validPrices.reduce((a, b) => a + b, 0) / validPrices.length).toFixed(0);
            const avgProduction = (validProduction.reduce((a, b) => a + b, 0) / validProduction.length).toFixed(0);

            // ìƒê´€ê³„ìˆ˜ ê³„ì‚°
            const correlation = calculateCorrelation(data.prices, data.production);

            // ìµœê³ ê°€ ì›”
            const maxPrice = Math.max(...data.prices);
            const maxPriceIndex = data.prices.indexOf(maxPrice);
            const peakMonth = months[maxPriceIndex];

            document.getElementById('avgPrice').textContent = Number(avgPrice).toLocaleString();
            document.getElementById('avgProduction').textContent = Number(avgProduction).toLocaleString();
            document.getElementById('correlation').textContent = isNaN(correlation) ? '-' : correlation.toFixed(3);
            document.getElementById('peakMonth').textContent = peakMonth;
        };

        // ìƒê´€ê³„ìˆ˜ ê³„ì‚°
        const calculateCorrelation = (x, y) => {
            // 0ì´ ì•„ë‹Œ ê°’ë“¤ë§Œ í•„í„°ë§
            const validPairs = x.map((xi, i) => [xi, y[i]]).filter(([xi, yi]) => xi > 0 && yi > 0);

            if (validPairs.length < 2) return 0;

            const validX = validPairs.map(pair => pair[0]);
            const validY = validPairs.map(pair => pair[1]);

            const n = validX.length;
            const sumX = validX.reduce((a, b) => a + b, 0);
            const sumY = validY.reduce((a, b) => a + b, 0);
            const sumXY = validX.reduce((acc, xi, i) => acc + xi * validY[i], 0);
            const sumX2 = validX.reduce((acc, xi) => acc + xi * xi, 0);
            const sumY2 = validY.reduce((acc, yi) => acc + yi * yi, 0);

            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

            return denominator === 0 ? 0 : numerator / denominator;
        };

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('prevYear').addEventListener('click', () => {
            const currentIndex = availableYears.indexOf(currentYear);
            if (currentIndex > 0) {
                currentYear = availableYears[currentIndex - 1];
                document.getElementById('yearDisplay').textContent = currentYear;
                updateCharts();
            }
        });

        document.getElementById('nextYear').addEventListener('click', () => {
            const currentIndex = availableYears.indexOf(currentYear);
            if (currentIndex < availableYears.length - 1) {
                currentYear = availableYears[currentIndex + 1];
                document.getElementById('yearDisplay').textContent = currentYear;
                updateCharts();
            }
        });

        document.getElementById('cropSelect').addEventListener('change', (e) => {
            currentCrop = e.target.value;
            if (cropData[currentCrop]) {
                updateCharts();
            }
        });

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            setupFileUploaders();
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „ë¼ë‚¨ë„ ì‘ë¬¼ ê²½ì‘ì§€ í”„ëœíŠ¸ë§µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #f57c00;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: bold;
        }

        .map-container {
            position: relative;
            width: 100%;
            height: 700px;
            border-radius: 15px;
            border: 3px solid #ff9800;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 12px;
        }

        .year-navigator {
            position: absolute;
            top: 10px;
            right: 50px;
            background: rgba(255,255,255,0.95);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .year-navigator button {
            background: #f57c00;
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .year-navigator button:hover {
            background: #e65100;
            transform: scale(1.1);
        }

        .year-navigator button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .year-display {
            font-size: 14px;
            font-weight: bold;
            color: #f57c00;
            min-width: 40px;
            text-align: center;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            border-radius: 12px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #f57c00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-window {
            padding: 8px;
            min-width: 120px;
            max-width: none;
            width: auto;
        }

        .info-window h3 {
            color: #f57c00;
            margin-bottom: 6px;
            font-size: 15px;
            white-space: nowrap;
        }

        .info-window p {
            margin: 3px 0;
            line-height: 1.3;
            font-size: 13px;
            white-space: nowrap;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #f57c00;
            font-size: 18px;
        }

        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(244, 67, 54, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 3000;
        }

        .debug-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
        }
    </style>

</head>
<body>
    <div class="container">
        <h1>ğŸŒ¾ ì „ë¼ë‚¨ë„ ì‘ë¬¼ ê²½ì‘ì§€ í”„ëœíŠ¸ë§µ ğŸŒ¾</h1>

        <div class="map-container">
            <div id="map">
                <div class="loading">Google Maps ë¡œë”© ì¤‘...</div>
            </div>

            <!-- ì—°ë„ ë„¤ë¹„ê²Œì´í„° -->
            <div class="year-navigator">
                <button id="prevYear" onclick="changeYear(-1)">â†</button>
                <div class="year-display" id="currentYear">2023</div>
                <button id="nextYear" onclick="changeYear(1)">â†’</button>
            </div>

            <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
            <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                <div class="loading-spinner"></div>
            </div>

            <!-- ë””ë²„ê·¸ ì •ë³´ -->
            <div id="debugInfo" class="debug-info" style="display: none;">
                <div>í˜„ì¬ ì—°ë„: <span id="debugYear"></span></div>
                <div>ë§ˆì»¤ ê°œìˆ˜: <span id="debugMarkers"></span></div>
                <div>ë°ì´í„° ê°œìˆ˜: <span id="debugData"></span></div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let infoWindow;
        let currentYear = 2023;
        let cropMarkers = [];
        let csvData = {};
        let activeInfoWindow = null;

        // ì‘ë¬¼ë³„ ê¸°ë³¸ ì •ë³´
        const cropInfo = {
            "ë§ˆëŠ˜": { emoji: "ğŸ§„", className: "garlic", color: "#f5f5f5" },
            "ì–‘íŒŒ": { emoji: "ğŸ§…", className: "onion", color: "#fff3e0" },
            "ë”¸ê¸°": { emoji: "ğŸ“", className: "strawberry", color: "#f48fb1" },
            "ë³µìˆ­ì•„": { emoji: "ğŸ‘", className: "peach", color: "#ffab91" }
        };

        // ì§€ì—­ë³„ ì¢Œí‘œ ì •ë³´ (ì •í™•í•œ ì¢Œí‘œë¡œ ìˆ˜ì •)
        const regionCoordinates = {
            "í•´ë‚¨êµ°": { lat: 34.5736, lng: 126.5988 },
            "ê³ í¥êµ°": { lat: 34.6131, lng: 127.2808 },
            "ë³´ì„±êµ°": { lat: 34.7714, lng: 127.0803 },
            "ë¬´ì•ˆêµ°": { lat: 34.9901, lng: 126.4816 },
            "í•¨í‰êµ°": { lat: 35.0661, lng: 126.5147 },
            "ì‹ ì•ˆêµ°": { lat: 34.8276, lng: 126.1060 },
            "ë‹´ì–‘êµ°": { lat: 35.3214, lng: 126.9881 },
            "ì¥ì„±êµ°": { lat: 35.3017, lng: 126.7886 },
            "ê³¡ì„±êµ°": { lat: 35.2819, lng: 127.2912 },
            "ê°•ì§„êµ°": { lat: 34.6415, lng: 126.7677 },
            "ìˆœì²œì‹œ": { lat: 34.9506, lng: 127.4872 },
            "í™”ìˆœêµ°": { lat: 35.0638, lng: 126.9853 }
        };

        function initMap() {
            // ë¡œë”© ë©”ì‹œì§€ ì œê±°
            const loadingDiv = document.querySelector('.loading');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }

            // ì „ë¼ë‚¨ë„ ì¤‘ì‹¬ ì¢Œí‘œ
            const jeonnamCenter = { lat: 34.8679, lng: 126.991 };

            // ì§€ë„ ì´ˆê¸°í™”
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 9,
                center: jeonnamCenter,
                mapTypeId: 'roadmap',
                mapTypeControl: false,
                styles: [
                    {
                        featureType: "administrative.province",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#2196f3" }, { weight: 2 }]
                    },
                    {
                        featureType: "landscape.natural",
                        elementType: "geometry.fill",
                        stylers: [{ color: "#fff3e0" }]
                    },
                    {
                        featureType: "water",
                        elementType: "geometry.fill",
                        stylers: [{ color: "#2196f3" }, { lightness: 10 }]
                    },
                    {
                        featureType: "landscape.natural.terrain",
                        elementType: "all",
                        stylers: [{ visibility: "off" }]
                    },
                    {
                        featureType: "landscape.man_made",
                        elementType: "all",
                        stylers: [{ visibility: "simplified" }]
                    },
                    {
                        featureType: "road.highway",
                        elementType: "all",
                        stylers: [{ visibility: "off" }]
                    },
                    {
                        featureType: "road.arterial",
                        elementType: "all",
                        stylers: [{ visibility: "off" }]
                    },
                    {
                        featureType: "road.local",
                        elementType: "all",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });

            // InfoWindow ì´ˆê¸°í™”
            infoWindow = new google.maps.InfoWindow();

            // ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™” (ê°œë°œìš©)
            if (window.location.hash === '#debug') {
                document.getElementById('debugInfo').style.display = 'block';
            }

            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadYearData(currentYear);
            updateNavigationButtons();
        }

        async function loadYearData(year) {
            showLoading(true);

            try {
                const mockData = await getMockCSVData(year);
                csvData[year] = mockData;
                console.log(`${year}ë…„ ë°ì´í„°:`, mockData);
                updateMarkers(year);
                updateDebugInfo(year, mockData);

            } catch (error) {
                console.error('CSV ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                showLoading(false);
            }
        }

        // ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì´ í•¨ìˆ˜ë¥¼ CSV íŒŒì¼ ì½ê¸° í•¨ìˆ˜ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤
        async function getMockCSVData(year) {
            // ì‹œë®¬ë ˆì´ì…˜ì„ ìœ„í•œ ì§€ì—°
            await new Promise(resolve => setTimeout(resolve, 800));

            // ë…„ë„ì— ë”°ë¥¸ ë³€ë™ ë°ì´í„° ìƒì„±
            const baseYear = 2023;
            const yearDiff = year - baseYear;
            const variation = 1 + (yearDiff * 0.02);

            const data = [
                // ë§ˆëŠ˜ ë°ì´í„° - 3ê°œ ì§€ì—­
                { crop: "ë§ˆëŠ˜", region: "í•´ë‚¨êµ°", production: Math.round(32940 * variation), price: Math.round(4580 * (1 + yearDiff * 0.03)) },
                { crop: "ë§ˆëŠ˜", region: "ê³ í¥êµ°", production: Math.round(28500 * variation), price: Math.round(4650 * (1 + yearDiff * 0.03)) },
                { crop: "ë§ˆëŠ˜", region: "ë³´ì„±êµ°", production: Math.round(25800 * variation), price: Math.round(4720 * (1 + yearDiff * 0.03)) },

                // ì–‘íŒŒ ë°ì´í„° - 4ê°œ ì§€ì—­
                { crop: "ì–‘íŒŒ", region: "ë¬´ì•ˆêµ°", production: Math.round(8560 * variation), price: Math.round(6320 * (1 + yearDiff * 0.04)) },
                { crop: "ì–‘íŒŒ", region: "ê³ í¥êµ°", production: Math.round(7200 * variation), price: Math.round(6150 * (1 + yearDiff * 0.04)) },
                { crop: "ì–‘íŒŒ", region: "í•¨í‰êµ°", production: Math.round(9800 * variation), price: Math.round(6400 * (1 + yearDiff * 0.04)) },
                { crop: "ì–‘íŒŒ", region: "ì‹ ì•ˆêµ°", production: Math.round(11200 * variation), price: Math.round(6250 * (1 + yearDiff * 0.04)) },

                // ë”¸ê¸° ë°ì´í„° - 5ê°œ ì§€ì—­
                { crop: "ë”¸ê¸°", region: "ë‹´ì–‘êµ°", production: Math.round(18340 * variation), price: Math.round(4200 * (1 + yearDiff * 0.025)) },
                { crop: "ë”¸ê¸°", region: "ì¥ì„±êµ°", production: Math.round(15600 * variation), price: Math.round(4150 * (1 + yearDiff * 0.025)) },
                { crop: "ë”¸ê¸°", region: "ë³´ì„±êµ°", production: Math.round(12800 * variation), price: Math.round(4300 * (1 + yearDiff * 0.025)) },
                { crop: "ë”¸ê¸°", region: "ê³¡ì„±êµ°", production: Math.round(14200 * variation), price: Math.round(4180 * (1 + yearDiff * 0.025)) },
                { crop: "ë”¸ê¸°", region: "ê°•ì§„êµ°", production: Math.round(16800 * variation), price: Math.round(4220 * (1 + yearDiff * 0.025)) },

                // ë³µìˆ­ì•„ ë°ì´í„° - 2ê°œ ì§€ì—­
                { crop: "ë³µìˆ­ì•„", region: "ìˆœì²œì‹œ", production: Math.round(5840 * variation), price: Math.round(6920 * (1 + yearDiff * 0.035)) },
                { crop: "ë³µìˆ­ì•„", region: "í™”ìˆœêµ°", production: Math.round(4200 * variation), price: Math.round(7100 * (1 + yearDiff * 0.035)) }
            ];

            return data;
        }

        function updateMarkers(year) {
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            cropMarkers.forEach(marker => {
                marker.setMap(null);
            });
            cropMarkers = [];

            // í™œì„± InfoWindow ë‹«ê¸°
            if (activeInfoWindow) {
                activeInfoWindow.close();
                activeInfoWindow = null;
            }

            const data = csvData[year];
            if (!data || data.length === 0) {
                console.warn(`${year}ë…„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            console.log(`${year}ë…„ ë§ˆì»¤ ì—…ë°ì´íŠ¸ ì‹œì‘, ë°ì´í„° ê°œìˆ˜:`, data.length);

            // ìƒˆ ë§ˆì»¤ ìƒì„±
            data.forEach((item, index) => {
                const coordinates = regionCoordinates[item.region];
                const info = cropInfo[item.crop];

                console.log(`ë§ˆì»¤ ${index + 1}: ${item.crop} - ${item.region}`, coordinates, info);

                if (coordinates && info) {
                    // ê°™ì€ ì§€ì—­ì— ì—¬ëŸ¬ ì‘ë¬¼ì´ ìˆì„ ê²½ìš° ìœ„ì¹˜ë¥¼ ì•½ê°„ ì¡°ì •
                    const sameRegionItems = data.filter(d => d.region === item.region);
                    const itemIndex = sameRegionItems.findIndex(d => d.crop === item.crop);

                    let adjustedLat = coordinates.lat;
                    let adjustedLng = coordinates.lng;

                    if (sameRegionItems.length > 1) {
                        // ì—¬ëŸ¬ ì‘ë¬¼ì´ ê°™ì€ ì§€ì—­ì— ìˆì„ ë•Œ ìœ„ì¹˜ ì¡°ì •
                        const offset = 0.02;
                        adjustedLat += (itemIndex - sameRegionItems.length / 2) * offset;
                        adjustedLng += (itemIndex - sameRegionItems.length / 2) * offset * 0.5;
                    }

                    const marker = new google.maps.Marker({
                        position: { lat: adjustedLat, lng: adjustedLng },
                        map: map,
                        title: `${item.region} ${item.crop}`,
                        icon: {
                            url: createMarkerIcon(info.emoji, info.className),
                            scaledSize: new google.maps.Size(60, 60),
                            anchor: new google.maps.Point(30, 30)
                        }
                    });

                    // InfoWindow ë‚´ìš© (ì—°ê°„ ì´ìƒì‚°ëŸ‰, kgë‹¹ í‰ê· ê°€ê²© ë¬¸êµ¬ ì œê±°)
                    const infoContent = `
                        <div class="info-window">
                            <h3>${item.crop} (${item.region})</h3>
                            <p><strong>ì—°ë„:</strong> ${year}ë…„</p>
                            <p><strong>ì§€ì—­:</strong> ${item.region}</p>
<!--                            <p><strong>ìƒì‚°ëŸ‰:</strong> ${item.production.toLocaleString()}í†¤</p>-->
<!--                            <p><strong>ê°€ê²©:</strong> ${item.price.toLocaleString()}ì›/kg</p>-->
                        </div>
                    `;

                    // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ìë™ìœ¼ë¡œ InfoWindow í‘œì‹œ
                    marker.addListener("mouseover", () => {
                        // ê¸°ì¡´ InfoWindow ë‹«ê¸°
                        if (activeInfoWindow) {
                            activeInfoWindow.close();
                        }

                        infoWindow.setContent(infoContent);
                        infoWindow.open(map, marker);
                        activeInfoWindow = infoWindow;

                        // ë§ˆì»¤ í¬ê¸° ì¦ê°€
                        marker.setIcon({
                            url: createMarkerIcon(info.emoji, info.className, true),
                            scaledSize: new google.maps.Size(72, 72),
                            anchor: new google.maps.Point(36, 36)
                        });
                    });

                    // ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì‹œ ë§ˆì»¤ í¬ê¸° ì›ë˜ëŒ€ë¡œ
                    marker.addListener("mouseout", () => {
                        marker.setIcon({
                            url: createMarkerIcon(info.emoji, info.className),
                            scaledSize: new google.maps.Size(60, 60),
                            anchor: new google.maps.Point(30, 30)
                        });
                    });

                    // í´ë¦­ ì‹œì—ë„ InfoWindow í‘œì‹œ
                    marker.addListener("click", () => {
                        if (activeInfoWindow) {
                            activeInfoWindow.close();
                        }

                        infoWindow.setContent(infoContent);
                        infoWindow.open(map, marker);
                        activeInfoWindow = infoWindow;
                    });

                    cropMarkers.push(marker);
                    console.log(`ë§ˆì»¤ ìƒì„± ì™„ë£Œ: ${item.crop} - ${item.region}`);
                } else {
                    console.warn(`ë§ˆì»¤ ìƒì„± ì‹¤íŒ¨: ${item.crop} - ${item.region}`, 'ì¢Œí‘œ:', coordinates, 'ì •ë³´:', info);
                }
            });

            console.log(`ì´ ${cropMarkers.length}ê°œ ë§ˆì»¤ ìƒì„± ì™„ë£Œ`);
        }

        function updateDebugInfo(year, data) {
            if (document.getElementById('debugInfo').style.display !== 'none') {
                document.getElementById('debugYear').textContent = year;
                document.getElementById('debugMarkers').textContent = cropMarkers.length;
                document.getElementById('debugData').textContent = data ? data.length : 0;
            }
        }

        function changeYear(direction) {
            const newYear = currentYear + direction;

            if (newYear >= 2004 && newYear <= 2023) {
                currentYear = newYear;
                document.getElementById('currentYear').textContent = currentYear;

                if (!csvData[currentYear]) {
                    loadYearData(currentYear);
                } else {
                    updateMarkers(currentYear);
                    updateDebugInfo(currentYear, csvData[currentYear]);
                }

                updateNavigationButtons();
            }
        }

        function updateNavigationButtons() {
            document.getElementById('prevYear').disabled = currentYear <= 2004;
            document.getElementById('nextYear').disabled = currentYear >= 2023;
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.map-container').appendChild(errorDiv);

            setTimeout(() => {
                errorDiv.remove();
            }, 3000);
        }

        function createMarkerIcon(emoji, className, isHovered = false) {
            const size = isHovered ? 72 : 60;
            const fontSize = isHovered ? 36 : 30;

            let backgroundColor;
            switch(className) {
                case 'strawberry':
                    backgroundColor = '#f48fb1';
                    break;
                case 'garlic':
                    backgroundColor = '#f5f5f5';
                    break;
                case 'peach':
                    backgroundColor = '#ffab91';
                    break;
                case 'onion':
                    backgroundColor = '#fff3e0';
                    break;
                default:
                    backgroundColor = '#fff3e0';
            }

            const svg = `
                <svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="${size/2}" cy="${size/2}" r="${size/2-3}"
                            fill="${backgroundColor}"
                            stroke="white"
                            stroke-width="3"
                            filter="drop-shadow(0 4px 8px rgba(0,0,0,0.2))"/>
                    <text x="${size/2}" y="${size/2}"
                          text-anchor="middle"
                          dominant-baseline="central"
                          font-size="${fontSize}"
                          font-family="Arial, sans-serif">${emoji}</text>
                </svg>
            `;

            return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
        }

        // Google Maps API ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
        window.gm_authFailure = function() {
            document.getElementById('map').innerHTML =
                '<div class="loading" style="color: #f44336;">Google Maps API ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
        };

        // ì—ëŸ¬ í•¸ë“¤ë§
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('Google')) {
                document.getElementById('map').innerHTML =
                    '<div class="loading" style="color: #f44336;">Google Maps ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        });
    </script>

    <!-- Google Maps API ë¡œë“œ -->
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATcVp3y-83dG4MV04e7NFJBReIqHp25Qk&callback=initMap">
    </script>
</body>
</html>




